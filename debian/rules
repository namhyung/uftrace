#!/usr/bin/make -f

# build with PIE explicitly where appropriate
export CFLAGS_uftrace=-fPIE
export CFLAGS_traceevent=-fPIE
export LDFLAGS_uftrace=-pie

# don't put current build paths in executables
export CFLAGS_configure=-ffile-prefix-map=$(CURDIR)=.

LIBDIR := /usr/lib/$(DEB_HOST_MULTIARCH)/uftrace

%:
	dh $@

ifneq (,$(filter nodoc,$(DEB_BUILD_OPTIONS)))
# suppress man page generation
export has_pandoc=no
endif

ifeq (,$(filter terse,$(DEB_BUILD_OPTIONS)))
# verbose build output
export V=1
endif

override_dh_auto_configure:
	LDFLAGS=-Wl,-z,now,-z,relro CFLAGS=$(CFLAGS_configure) ./configure --prefix=/usr --libdir=$(LIBDIR)

override_dh_auto_install:
	$(MAKE) install DESTDIR=$(CURDIR)/debian/tmp/

ifeq (,$(filter nocheck,$(DEB_BUILD_OPTIONS)))
override_dh_auto_test:
	$(MAKE) test
endif

override_dh_auto_clean:
	dh_auto_clean
	$(RM) -r .config tests/__pycache__ tests/failed-tests.txt
	$(MAKE) -C check-deps check-clean
